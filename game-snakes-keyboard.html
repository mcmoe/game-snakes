<link rel="import" href="../polymer/polymer.html">
<script>
	/*
	*An element providing keyboard controls for `game-snakes` element.
	*
	*| Action | Key |
	*| --- | --- |
	*| play | space |
	*| pause | space |
	*| turn up | up arrow or 'w' |
	*| turn down | down arrow or 's' |
	*| turn left | left arrow or 'a' |
	*| turn right | right arrow or 'd' |
	*/
	Polymer({
		is: 'game-snakes-keyboard',
		properties: {
			/*
			*`game-snakes` element to be used as target.
			*@default parent
			*/
			target: {
				type: HTMLElement,
				value: function() {
					return Polymer.dom(this).parentNode;
				},
				observer: '_targetChanged'
			},
			/*
			*Enables or disables keyboard controls.
			*/
			active: {
				type: Boolean,
				value: true,
				observer: '_activeChanged'
			}
		},
		_targetChanged: function(e) {
			var f = 'function';
			if (e && typeof e.play === f && typeof e.pause === f && typeof e.turn === f) {
				this._validTarget = true;
			} else {
				this._validTarget = false;
			}
			this._check();
		},
		_activeChanged: function() {
			this._check();
		},
		_check: function() {
			if (this.active && this._validTarget) {
				if (!this._added) {
					this._added = true;
					addEventListener('keydown', this._handle);
				}
			} else {
				if (this._added) {
					this._added = false;
					removeEventListener('keydown', this._handle);
				}
			}
		},
		_handle: function(e) {
			var index = -1;
			var key = e.key;
			if (key) {
				key = key.toLowerCase();
				for (var i = 0; i < 5; i++) {
					if (this._keys[i].indexOf(key) !== -1) {
						index = i;
						break;
					}
				}
			}
			if (index === -1) {
				for (var i = 0; i < 5; i++) {
					if (this._codes[i].indexOf(e.keyCode) !== -1) {
						index = i;
						break;
					}
				}
			}
			if (index !== -1) {
				var tar = this.target;
				e.preventDefault();
				if (index === 4) {
					if (tar.state === 'playing') {
						tar.pause();
					} else {
						tar.play();
					}
				} else {
					tar.turn(this._dir[index]);
				}
			}
		},
		created: function() {
			this._handle = this._handle.bind(this);
			this._dir = ['up', 'down', 'left', 'right'];
			this._keys = [
				['arrowup', 'w'],
				['arrowdown', 's'],
				['arrowleft', 'a'],
				['arrowright', 'd'],
				[' ']
			];
			this._codes = [
				[38, 87],
				[40, 83],
				[37, 65],
				[39, 68],
				[32]
			];
		}
	});
</script>
