<link rel="import" href="../polymer/polymer.html">
<!--
An element providing a snakes game.

Example:

		<game-snakes size="32" height="12" width="16" gap="4" time="1000"></game-snakes>

Add game-snakes-keyboard and game-snakes-gesture elements for keyboard, mouse and touch controls.

Example:

		<game-snakes>
				<game-snakes-keyboard></game-snakes-keyboard>
				<game-snakes-gesture></game-snakes-gesture>
		</game-snakes>

@demo demo/
-->
<dom-module id="game-snakes">
	<template>
		<style>
			:host {
				display: block;
				background-color: #FFFFFF;
				position: relative;
				-webkit-user-select: none;
				user-select: none;
			}
			.tail, #food, #head {
				position: absolute;
				top: 0;
				left: 0;
			}
			.tail {
				background-color: #388E3C;
				border-radius: 2px;
				background: var(--game-snakes-tail-background);
				@apply(--game-snakes-tail);
			}
			#food {
				background-color: #FF4081;
				border-radius: 50%;
				background: var(--game-snakes-food-background);
				@apply(--game-snakes-food);
			}
			#head {
				background-color: #212121;
				border-radius: 2px;
				background: var(--game-snakes-head-background);
				@apply(--game-snakes-head);
			}
		</style>
		<div id="tails"></div>
		<div id="food"></div>
		<div id="head"></div>
	</template>
	<script>
		Polymer({
			is: 'game-snakes',
			properties: {
				/*
				*Block size, in pexels.
				*/
				size: {
					type: Number,
					value: 20,
					observer: '_sizeChanged'
				},
				/*
				*Number of blocks in vertical direction.
				*/
				height: {
					type: Number,
					value: 16,
					observer: '_heightChanged'
				},
				/*
				*Number of blocks in horizontal direction.
				*/
				width: {
					type: Number,
					value: 16,
					observer: '_widthChanged'
				},
				/*
				*Gap between blocks.
				*/
				gap: {
					type: Number,
					value: 2,
					observer: '_gapChanged'
				},
				/*
				*Time between each move. Decreasing this will increase the speed of the game.
				*/
				time: {
					type: Number,
					value: 100,
					observer: '_timeChanged'
				},
				/*
				*Eating food will increase the `score`. `score` is set to 0 when game starts.
				*/
				score: {
					type: Number,
					value: 0,
					readOnly: true,
					notify: true
				},
				/*
				*State of the game: `'playing'`, `'paused'` or `'stopped'`.
				*/
				state: {
					type: String,
					value: 'stopped',
					readOnly: true,
					notify: true,
					observer: '_stateChanged'
				}
			},
			_sizeChanged: function(newVal, oldVal) {
				if (newVal <= 0) {
					console.warn('game-snakes.size is not a positive number: found ' + newVal);
					this.size = oldVal;
					return;
				}
				this._setSize();
			},
			_heightChanged: function(newVal, oldVal) {
				if (newVal <= 5 || !Number.isInteger(newVal)) {
					console.warn('game-snakes.height is not a integer greater than 5: found ' + newVal);
					this.height = oldVal;
					return;
				}
				if (this.state === 'stopped') {
					this._currHeight = this.height;
					this._setHeight();
				}
			},
			_widthChanged: function(newVal, oldVal) {
				if (newVal <= 5 || !Number.isInteger(newVal)) {
					console.warn('game-snakes.width is not a integer greater than 5: found ' + newVal);
					this.width = oldVal;
					return;
				}
				if (this.state === 'stopped') {
					this._currWidth = this.width;
					this._setWidth();
				}
			},
			_gapChanged: function(newVal, oldVal) {
				if (newVal <= 0) {
					console.warn('game-snakes.gap is not a positive number: found ' + newVal);
					this.gap = oldVal;
					return;
				}
				this._setGap();
			},
			_timeChanged: function(newVal, oldVal) {
				if (newVal <= 0 || !Number.isInteger(newVal)) {
					console.warn('game-snakes.time is not a positive integer: found ' + newVal);
					this.time = oldVal;
					return;
				}
				if (this.state !== 'playing') {
					this._currTime = newVal;
				}
			},
			_stateChanged: function(newVal, oldVal) {
				var newGame = newVal === 'playing' && oldVal === 'stopped';
				var stopped = newVal === 'stopped';
				if (stopped) {
					clearInterval(this._move);
					if (oldVal) {
						this._timeouts.forEach(clearTimeout);
					}
					this._timeouts = [];
					this._currTime = this.time;
					if (this._currHeight !== this.height) {
						this._currHeight = this.height;
						this._setHeight();
					}
					if (this._currWidth !== this.width) {
						this._currWidth = this.width;
						this._setWidth();
					}
					this.$.tails.innerHTML = '';
					this.$.food.style.opacity = '0';
					this._x = 4;
					this._y = this.height % 2 === 0 ? (this.height - 2) / 2 : (this.height - 1) / 2;
					this._position(this._x, this._y, this.$.head);
					this._tails = [];
					this._tailPos = [{
						x: 3,
						y: this._y
					}, {
						x: 2,
						y: this._y
					}, {
						x: 1,
						y: this._y
					}];
					this._tailPos.forEach(function(pos) {
						this._createTail(pos.x, pos.y);
					}.bind(this));
				} else if (newGame) {
					this._direction = 'right';
					this._setScore(0);
					this._setFood();
					this.$.food.style.opacity = '1';
				}
				if (newVal === 'playing') {
					this._startMoving();
				} else if (newVal === 'paused') {
					clearInterval(this._move);
				}
			},
			_setHeight: function() {
				if (!this._isReady) return;
				this.style.height = this._currHeight * this.size + this.gap * (this._currHeight - 1) + 'px';
			},
			_setWidth: function() {
				if (!this._isReady) return;
				this.style.width = this._currWidth * this.size + this.gap * (this._currWidth - 1) + 'px';
			},
			_setGap: function() {
				if (!this._isReady) return;
				this._setHeight();
				this._setWidth();
			},
			_setSize: function() {
				if (!this._isReady) return;
				this._currHeight = this.height;
				this._currWidth = this.width;
				this._setHeight();
				this._setWidth();
				this.$.food.style.height = this.size + 'px';
				this.$.food.style.width = this.size + 'px';
				this.$.head.style.height = this.size + 'px';
				this.$.head.style.width = this.size + 'px';
			},
			_position: function(x, y, node) {
				var block =  this.size + this.gap;
				this.transform('translate(' + x * block + 'px, ' + y * block + 'px)', node);
			},
			_createTail: function(x, y) {
				var div = this.create('div');
				this.toggleClass('tail', true, div);
				div.style.height = this.size + 'px';
				div.style.width = this.size + 'px';
				this._position(x, y, div);
				this._tails.push(div);
				Polymer.dom(this.$.tails).appendChild(div);
			},
			_setFood: function() {
				var inTail = false;
				this._foodX = 0;
				this._foodY = 0;
				var length = this._tailPos.length;
				do {
					var inTail = false;
					this._foodX = Math.floor(Math.random() * this._currWidth);
					this._foodY = Math.floor(Math.random() * this._currHeight);
					for (var i = 0; i < length; i++) {
						if (this._foodX === this._tailPos[i].x && this._foodY === this._tailPos[i].y) {
							inTail = true;
							break;
						}
					}
				} while(inTail || (this._foodX === this._x && this._foodY === this._y));
				this._position(this._foodX, this._foodY, this.$.food);
			},
			_moving: function(e) {
				var length = this._tailPos.length;
				this._tailPos.unshift({
					x: this._x,
					y: this._y
				});
				this._tailPos.pop();
				if (e === 'up') {
					this._y--;
					if (this._y < 0) {
						this.stop();
					}
				} else if (e === 'down') {
					this._y++;
					if (this._y >= this._currHeight) {
						this.stop();
					}
				} else if (e === 'left') {
					this._x--;
					if (this._x < 0) {
						this.stop();
					}
				} else {
					this._x++;
					if (this._x >= this._currWidth) {
						this.stop();
					}
				}
				for (var i = 0; i < length && this.state !== 'stopped'; i++) {
					var pos = this._tailPos[i];
					if (pos.x === this._x && pos.y === this._y) {
						this.stop();
					}
				}
				if (this.state === 'stopped') {
					return;
				}
				this._tailPos.forEach(function(pos, index) {
					this._position(pos.x, pos.y, this._tails[index]);
				}.bind(this));
				if (this._x === this._foodX && this._y === this._foodY) {
					this._timeouts.push(setTimeout(function() {
						this._tailPos.unshift({
							x: this._x,
							y: this._y
						});
						this._createTail(this._x, this._y);
					}.bind(this), this._currTime * this.score));
					this._setScore(this.score + 1);
					this._setFood();
				}
				this._position(this._x, this._y, this.$.head);
			},
			_startMoving: function() {
				this._moving(this._direction);
				this._move = setInterval(function() {
					this._moving(this._direction);
				}.bind(this), this._currTime);
			},
			ready: function() {
				this._isReady = true;
				this._setSize();
			},
			/*
			*Starts or resumes game.
			*/
			play: function() {
				this._setState('playing');
			},
			/*
			*Pauses game.
			*/
			pause: function() {
				if (this.state === 'playing') {
					this._setState('paused');
				}
			},
			/*
			*Stops game.
			*/
			stop: function() {
				this._setState('stopped');
			},
			/*
			*Turns the sanke.
			*
			*`Direction` is a `String`: `'up'`, `'down'`, `'right'` or `'left'`.
			*/
			turn: function(direction) {
				var e = direction;
				var f = this._direction;
				if (this.state !== 'playing' || e === f || (e === 'up' && f === 'down') || (e === 'down' && f === 'up') || (e === 'left' && f === 'right') || (e === 'right' && f === 'left')) {
					return;
				}
				clearInterval(this._move);
				this._direction = e;
				this._startMoving();
			}
    });
  </script>
</dom-module>
