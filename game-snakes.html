<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-icons/av-icons.html">
<link rel="import" href="../paper-fab/paper-fab.html">

<!--
Element providing a basic configurable snakes game.
##### Example:
    <game-snakes></game-snakes>
##### Example with changed size, height, width, time and instructions:
	<game-snakes size="20" height="15" width="25" time="60" instructions="The regular snakes game"></game-snakes>
##### Changing style:
	<style>
	
		game-snakes {
			background-color: #4A148C;
		}
	
		/*styling play button*/
		game-snakes::shadow #play {
			background-color: #7B1FA2;
		}
	
		/*styling play food*/
		game-snakes::shadow #food {
			border-radius: 2px;
			box-shadow: none;
		}
	
		/*styling snake's head and tail*/
		game-snakes::shadow .tail, game-snakes::shadow #head {
			background-color: transparent;
			background-image: url('../game-snakes/hexagon.png');
			background-repeat: no-repeat;
			background-size: contain;
			box-shadow: none;
		}
	
		/*styling the overlay behind play button*/
		game-snakes::shadow #overlay {
			background-color: rgba(255,255,255,0.54);
		}
	
	</style>
@element game-snakes
@blurb Element providing a basic configurable snakes game.
@status beta
@homepage https://github.com/namannehra/game-snakes/
-->

<polymer-element name="game-snakes" attributes="size height width time instructions">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				-webkit-user-select: none;
				user-select: none;
			}
			#food, .tail, #head {
				box-shadow: 0 2px 10px 0 rgba(0, 0, 0, 0.16), 0 2px 5px 0 rgba(0, 0, 0, 0.26);
				margin: 2px 0 0 2px;
				position: absolute;
			}
			#food {
				display: none;
				background-color: #FF4081;
				border-radius: 50%;
			}
			.tail {
				background-color: #388E3C;
				border-radius: 2px;
			}
			#head {
				background-color: #212121;
				border-radius: 2px;
			}
			#overlay {
				background-color: rgba(0,0,0,0.54);
				-webkit-transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1);
				transition: opacity 0.4s cubic-bezier(0.4,0,0.2,1);
			}
			paper-fab {
				background-color: #4CAF50;
				margin: auto;
				-webkit-transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
				transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
			}
		</style>
		<div id="food"></div>
		<div id="tails"></div>
		<div id="head"></div>
		<div id="overlay" fit>
			<paper-fab id="playButton" icon="av:play-arrow" fit></paper-fab>
		</div>
	</template>
	<script>
		(function() {
			var gameSnakes, direction, move, foodTop, foodLeft, tailTop, tailLeft, headTop, headLeft, food, tails, tail, head, overlay, playButton;
			function begin() {
				direction = 'none';
				headTop = gameSnakes.height * gameSnakes.size / 2 - gameSnakes.size;
				headLeft = gameSnakes.width * gameSnakes.size / 2 + gameSnakes.size;
				tailTop = [headTop, headTop, headTop];
				tailLeft = [headLeft - (3 * gameSnakes.size), headLeft - (2 * gameSnakes.size), headLeft - gameSnakes.size];
				head.style.top = headTop + 'px';
				head.style.left = headLeft + 'px';
				for (var i = 0; i < 3; i++) {
					setTail();
					tail.id = 'tail' + i;
					tail.style.top = tailTop[i] + 'px';
					tail.style.left = tailLeft[i] + 'px';
					tails.appendChild(tail);
				}
				createFood();
			}
			function setTail() {
				tail = document.createElement('div');
				tail.className = 'tail';
				tail.style.height = gameSnakes.size - 4 + 'px';
				tail.style.width = gameSnakes.size - 4 + 'px';
			}
			function growTail() {
				setTail();
				tail.id = 'tail' + (gameSnakes.score + 2);
				tail.style.top = headTop + 'px';
				tail.style.left = headLeft + 'px';
				setTimeout(function(){
					tails.appendChild(tail);
				}, tails.childNodes.length * gameSnakes.time);
			}
			function createFood() {
				loop:while (true) {
					foodTop = Math.floor(Math.random() * gameSnakes.height) * gameSnakes.size;
					foodLeft = Math.floor(Math.random() * gameSnakes.width) * gameSnakes.size;
					for (var i = 0; i <= tails.childNodes.length; i++) {
						if (foodTop == tailTop[tailTop.length - i] && foodLeft == tailLeft[tailLeft.length - i]) {
							continue loop;
						}
					}
					break;
				}
				food.style.top = foodTop + 'px';
				food.style.left = foodLeft + 'px';
			}
			function play() {
				gameSnakes.score = 0;
				gameSnakes.playing = true;
				food.style.display = 'block';
				overlay.style.opacity = '0';
				playButton.style.webkitTransform = 'scale(0)';
				playButton.style.transform = 'scale(0)';
				document.onkeydown = function(e) {
					if (gameSnakes.playing) {
						if (!(direction == 'up' || direction == 'down')) {
							if (e.keyCode == 38 || e.keyCode == 87) {
								turn('up');
							}
							if (e.keyCode == 40 || e.keyCode == 83) {
								turn('down');
							}
						}
						if (!(direction == 'right' || direction == 'left')) {
							if (e.keyCode == 39 || e.keyCode == 68) {
								turn('right');
							}
							if (direction != 'none' && (e.keyCode == 37 || e.keyCode == 65)) {
								turn('left');
							}
						}
					}
				}
			}
			function end() {
				gameSnakes.playing = false;
				clearInterval(move);
				food.style.display = 'none';
				overlay.style.opacity = '1';
				playButton.style.webkitTransform = 'none';
				playButton.style.transform = 'none';
				while (tails.firstChild) {
					tails.removeChild(tails.firstChild);
				}
				begin();
			}
			function turn(e) {
				function moving() {
					tailTop[tailTop.length] = headTop;
					tailLeft[tailLeft.length] = headLeft;
					if (e == 'up') {
						headTop -= gameSnakes.size;
						if (headTop < 0) {
							end();
						} else {
							head.style.top = headTop + 'px';
						}
					}
					if (e == 'right') {
						headLeft += gameSnakes.size;
						if (headLeft >= gameSnakes.width * gameSnakes.size) {
							end();
						} else {
							head.style.left = headLeft + 'px';
						}
					}
					if (e == 'down') {
						headTop += gameSnakes.size;
						if (headTop >= gameSnakes.height * gameSnakes.size) {
							end();
						} else {
							head.style.top = headTop + 'px';
						}
					}
					if (e == 'left') {
						headLeft -= gameSnakes.size;
						if (headLeft < 0) {
							end();
						} else {
							head.style.left = headLeft + 'px';
						}
					}
					if (gameSnakes.playing) {
						for (var i = 0; i < tails.childNodes.length; i++) {
							tails.childNodes[i].style.top = tailTop[tailTop.length - i - 1] + 'px';
							tails.childNodes[i].style.left = tailLeft[tailLeft.length - i - 1] + 'px';
						}
					}
					if (headTop == foodTop && headLeft == foodLeft) {
						gameSnakes.score++;
						growTail();
						createFood();
					}
					for (var i = 0; i < tails.childNodes.length; i++) {
						if (headTop == tailTop[tailTop.length - i - 1] && headLeft == tailLeft[tailLeft.length - i -1]) {
							end();
							break;
						}
					}
				}
				direction = e;
				clearInterval(move);
				moving();
				if (gameSnakes.playing) {
					move = setInterval(function() {
						moving();
					}, gameSnakes.time);
				}
			}
			Polymer({
				/**
				  * Sets the size of one block in px
				  * @attribute size
				  * @type number
				  * @default 24
				*/
				size: 24,
				/**
				  * Sets the number of blocks in height of the game area
				  * @attribute height
				  * @type number
				  * @default 20
				*/
				height: 20,
				/**
				  * Sets the number of blocks in width of the game area
				  * @attribute width
				  * @type number
				  * @default 20
				*/
				width: 20,
				/**
				  * Sets the time in which snake moves one block in milliseconds (Reducing this value will increase speed of the snake)
				  * @attribute time
				  * @type number
				  * @default 100
				*/
				time: 100,
				/**
				  * Sets the instructions of the game
				  * @attribute instructions
				  * @type string
				  * @default 'Use arrow keys or "a, s, w, d" to move'
				*/
				instructions: 'Use arrow keys or "a, s, w, d" to move',
				/**
				  * Returns the current score
				  * @attribute score
				  * @type number
				  * @default 0
				*/
				score: 0,
				/**
				  * Returns true if game is running
				  * @attribute playing
				  * @type boolean
				  * @default false
				*/
				playing: false,
				/**
				  * Fired whenever the score changes
				  * @event score
				*/
				scoreChanged: function() {
					this.fire('score');
				},
				/**
				  * Fired when the game starts or ends
				  * @event playing
				*/
				playingChanged: function() {
					this.fire('playing');
				},
				created: function() {
					gameSnakes = this;
				},
				ready: function() {
					food = this.$.food;
					tails = this.$.tails;
					head = this.$.head;
					overlay = this.$.overlay;
					playButton = this.$.playButton;
					this.style.height = this.height * this.size + 'px';
					this.style.width = this.width * this.size + 'px';
					food.style.height = this.size - 4 + 'px';
					food.style.width = this.size - 4 + 'px';
					head.style.height = this.size - 4 + 'px';
					head.style.width = this.size - 4 + 'px';
					this.$.playButton.onclick = function() {
						play();
					};
					begin();
				}
			});
		})();
	</script>
</polymer-element>
