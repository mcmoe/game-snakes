<link rel="import" href="../polymer/polymer.html">

<!--
Web component providing a basic configurable snakes game. Use use arrow keys or 'a', 's', 'w', 'd' or touch screen to move. Use Space bar or Esc to pause/resume.
##### Example:
    <game-snakes></game-snakes>
##### Example with changed size, height, width and time:
	<game-snakes size="40" height="10" width="10" time="60"></game-snakes>
##### Changing style:
	<style>
	
		game-snakes {
			background-color: #4A148C;
		}
	
		/*styling play food*/
		game-snakes::shadow #food {
			border-radius: 2px;
			box-shadow: none;
		}
	
		/*styling snake's tail and head*/
		game-snakes::shadow .tail, game-snakes::shadow #head {
			background-color: transparent;
			background-image: url('../game-snakes/hexagon.png');
			background-repeat: no-repeat;
			background-size: contain;
			box-shadow: none;
		}
	
	</style>
@element game-snakes
@blurb Web component providing a basic configurable snakes game. Use use arrow keys or 'a', 's', 'w', 'd' or touch screen to move.
@status beta
@homepage https://github.com/namannehra/game-snakes/
-->

<polymer-element name="game-snakes" attributes="size height width time score state">
	<template>
		<style>
			:host {
				display: block;
				-webkit-user-select: none;
				user-select: none;
			}
			#container {
				height: 100%;
				position: relative;
			}
			#food, .tail, #head {
				margin: 2px 0 0 2px;
				position: absolute;
				top: 0;
				left: 0;
			}
			#food {
				display: none;
				background-color: #FF4081;
				border-radius: 50%;
			}
			.tail {
				background-color: #388E3C;
				border-radius: 2px;
			}
			#head {
				background-color: #212121;
				border-radius: 2px;
			}
		</style>
		<div id="container" on-trackstart="{{trackstart}}" on-track="{{track}}">
			<div id="food"></div>
			<div id="tails"></div>
			<div id="head"></div>
		</div>
	</template>
	<script>
		Polymer({
			/**
			  * Sets the size of one block in px
			  * @attribute size
			  * @type number
			  * @default 25
			*/
			size: 25,
			/**
			  * Sets the number of blocks in height of the game area
			  * @attribute height
			  * @type number
			  * @default 16
			*/
			height: 16,
			/**
			  * Sets the number of blocks in width of the game area
			  * @attribute width
			  * @type number
			  * @default 16
			*/
			width: 16,
			/**
			  * Sets the time in which snake moves one block in milliseconds (Reducing this value will increase speed of the snake)
			  * @attribute time
			  * @type number
			  * @default 100
			*/
			time: 100,
			/**
			  * Returns the current score
			  * @attribute score
			  * @type number
			  * @default 0
			*/
			score: 0,
			/**
			  * Returns or sets the state of the game ('playing', 'paused' or 'stopped')
			  * @attribute state
			  * @type string
			  * @default 'stopped'
			*/
			state: 'stopped',
			ready: function() {
				this.style.height = this.height * this.size + 'px';
				this.style.width = this.width * this.size + 'px';
				this.$.food.style.height = this.size - 4 + 'px';
				this.$.food.style.width = this.size - 4 + 'px';
				this.$.head.style.height = this.size - 4 + 'px';
				this.$.head.style.width = this.size - 4 + 'px';
				this.begin();
			},
			begin: function() {
				this.direction = 'right';
				this.headTop = (this.height % 2 == 0) ? this.height * this.size / 2 - this.size : this.height * this.size / 2;
				this.headLeft = this.size * 4;
				this.tailTop = [this.headTop, this.headTop, this.headTop];
				this.tailLeft = [this.headLeft - (3 * this.size), this.headLeft - (2 * this.size), this.headLeft - this.size];
				this.$.container.removeAttribute('touch-action');
				this.$.head.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
				this.$.head.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
				for (var i = 0; i < 3; i++) {
					this.setTail();
					this.tail.id = 'tail' + i;
					this.tail.style.webkitTransform = 'translateX(' + this.tailLeft[i] + 'px) translateY(' + this.tailTop[i] + 'px)';
					this.tail.style.transform = 'translateX(' + this.tailLeft[i] + 'px) translateY(' + this.tailTop[i] + 'px)';
					this.$.tails.appendChild(this.tail);
				}
				this.createFood();
			},
			createFood: function() {
				loop:while (true) {
					this.foodTop = Math.floor(Math.random() * this.height) * this.size;
					this.foodLeft = Math.floor(Math.random() * this.width) * this.size;
					for (var i = 0; i <= this.$.tails.childNodes.length; i++) {
						if (this.foodTop == this.tailTop[this.tailTop.length - i] && this.foodLeft == this.tailLeft[this.tailLeft.length - i]) {
							continue loop;
						}
					}
					break;
				}
				this.$.food.style.webkitTransform = 'translateX(' + this.foodLeft + 'px) translateY(' + this.foodTop + 'px)';
				this.$.food.style.transform = 'translateX(' + this.foodLeft + 'px) translateY(' + this.foodTop + 'px)';
			},
			setTail: function() {
				this.tail = document.createElement('div');
				this.tail.className = 'tail';
				this.tail.style.height = this.size - 4 + 'px';
				this.tail.style.width = this.size - 4 + 'px';
			},
			growTail: function() {
				this.setTail();
				this.tail.id = 'tail' + (this.score + 2);
				this.tail.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
				this.tail.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
				this.async(function() {
					this.$.tails.appendChild(this.tail);
				}, null, this.$.tails.childNodes.length * this.time);
			},
			trackstart: function(e) {
				this.trackstartX = e.clientX;
				this.trackstartY = e.clientY;
				this.trackend = false;
			},
			track: function(e) {
				if (this.state == 'playing' && !this.trackend) {
					this.trackX = e.clientX - this.trackstartX;
					this.trackY = e.clientY - this.trackstartY;
					if (Math.abs(this.trackX) >= Math.abs(this.trackY) && !(this.direction == 'right' || this.direction == 'left')) {
						if (this.trackX > 0) {
							this.turn('right');
							this.trackend = true;
						} else if (this.trackX < 0) {
							this.turn('left');
							this.trackend = true;
						}
					}
					if (Math.abs(this.trackX) <= Math.abs(this.trackY) && !(this.direction == 'up' || this.direction == 'down')) {
						if (this.trackY > 0) {
							this.turn('down');
							this.trackend = true;
						} else if (this.trackY < 0) {
							this.turn('up');
							this.trackend = true;
						}
					}
				}
			},
			turn: function(e) {
				this.direction = e;
				clearInterval(this.move);
				this.moving(e);
				if (this.state == 'playing') {
					this.move = setInterval(function() {
						this.moving(e);
					}.bind(this), this.time);
				}
			},
			moving: function(e) {
				this.tailTop[this.tailTop.length] = this.headTop;
				this.tailLeft[this.tailLeft.length] = this.headLeft;
				if (e == 'up') {
					this.headTop -= this.size;
					if (this.headTop < 0) {
						this.state = 'stopped';
					} else {
						this.$.head.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
						this.$.head.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
					}
				}
				if (e == 'right') {
					this.headLeft += this.size;
					if (this.headLeft >= this.width * this.size) {
						this.state = 'stopped';
					} else {
						this.$.head.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
						this.$.head.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
					}
				}
				if (e == 'down') {
					this.headTop += this.size;
					if (this.headTop >= this.height * this.size) {
						this.state = 'stopped';
					} else {
						this.$.head.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
						this.$.head.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
					}
				}
				if (e == 'left') {
					this.headLeft -= this.size;
					if (this.headLeft < 0) {
						this.state = 'stopped';
					} else {
						this.$.head.style.webkitTransform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
						this.$.head.style.transform = 'translateX(' + this.headLeft + 'px) translateY(' + this.headTop + 'px)';
					}
				}
				if (this.state == 'playing') {
					for (var i = 0; i < this.$.tails.childNodes.length; i++) {
						this.$.tails.childNodes[i].style.webkitTransform = 'translateX(' + this.tailLeft[this.tailLeft.length - i - 1] + 'px) translateY(' + this.tailTop[this.tailTop.length - i - 1] + 'px)';
						this.$.tails.childNodes[i].style.transform = 'translateX(' + this.tailLeft[this.tailLeft.length - i - 1] + 'px) translateY(' + this.tailTop[this.tailTop.length - i - 1] + 'px)';
					}
				}
				if (this.headTop == this.foodTop && this.headLeft == this.foodLeft) {
					this.score++;
					this.growTail();
					this.createFood();
				}
				for (var i = 0; i < this.$.tails.childNodes.length; i++) {
					if (this.headTop == this.tailTop[this.tailTop.length - i - 1] && this.headLeft == this.tailLeft[this.tailLeft.length - i -1]) {
						this.state = 'stopped';
						break;
					}
				}
			},
			/**
			  * Fired whenever the score changes
			  * @event score-change
			*/
			scoreChanged: function() {
				this.fire('score-change');
			},
			/**
			  * Fired whenever the state changes
			  * @event state-change
			*/
			stateChanged: function(e,f) {
				if (f == 'playing') {
					this.$.container.setAttribute('touch-action', 'none');
					this.$.food.style.display = 'block';
					this.turn(this.direction);
					if (e == 'stopped') {
						this.score = 0;
					}
					document.onkeydown = function(e) {
						if (this.state == 'playing') {
							if (e.keyCode == 27 || e.keyCode == 32) {
								this.state = 'paused';
							} else if (!(this.direction == 'up' || this.direction == 'down')) {
								if (e.keyCode == 38 || e.keyCode == 87) {
									this.turn('up');
								}
								if (e.keyCode == 40 || e.keyCode == 83) {
									this.turn('down');
								}
							} else if (!(this.direction == 'right' || this.direction == 'left')) {
								if (e.keyCode == 39 || e.keyCode == 68) {
									this.turn('right');
								}
								if (e.keyCode == 37 || e.keyCode == 65) {
									this.turn('left');
								}
							}
							if (e.keyCode == 27 || e.keyCode == 32 || e.keyCode == 38 || e.keyCode == 87 || e.keyCode == 40 || e.keyCode == 83 || e.keyCode == 39 || e.keyCode == 68 || e.keyCode == 37 || e.keyCode == 65) {
								return false;
							}
						}
					}.bind(this)
				} else if (f == 'paused') {
					clearInterval(this.move);
					document.onkeydown = function(e) {
						if (this.state == 'paused' && (e.keyCode == 27 || e.keyCode == 32)) {
							this.state = 'playing';
							return false;
						}
						return false;
					}.bind(this)
				}else if (f == 'stopped') {
					clearInterval(this.move);
					this.$.food.style.display = 'none';
					while (this.$.tails.firstChild) {
						this.$.tails.removeChild(this.$.tails.firstChild);
					}
					this.begin();
				} else {
					console.log("Error: State property set to '" + f + "' .This property cannot be anything other than 'playing', 'paused' or 'stopped'.")
				}
				this.fire('state-change');
			}
		});
	</script>
</polymer-element>
